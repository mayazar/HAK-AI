<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>מחוון עבודות עם כלי בינה מלאכותית</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7fb;
      direction: rtl;
    }

    header {
      background: #e91e63;
      color: white;
      padding: 1.2rem 1.5rem;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    header p {
      margin: 0.3rem 0 0;
      font-size: 0.95rem;
      opacity: 0.9;
    }

    main {
      max-width: 1000px;
      margin: 1.2rem auto 2rem;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 1.2rem 1.4rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 1rem;
    }

    .flex {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .space-between {
      justify-content: space-between;
    }

    label {
      font-weight: 600;
    }

    select, input[type="number"], input[type="text"], textarea, button {
      font-family: inherit;
      font-size: 0.95rem;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
    }

    textarea {
      width: 100%;
      min-height: 60px;
      resize: vertical;
    }

    select:focus, input:focus, textarea:focus, button:focus {
      outline: none;
      border-color: #e91e63;
      box-shadow: 0 0 0 2px rgba(233,30,99,0.15);
    }

    button {
      background: #e91e63;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem 0.9rem;
    }

    button.secondary {
      background: #f0f0f5;
      color: #333;
    }

    button.danger {
      background: #b71c1c;
      color: #fff;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .role-toggle button {
      flex: 1;
    }

    .role-toggle button.active {
      background: #e91e63;
      color: white;
    }

    .role-toggle button:not(.active) {
      background: white;
      border: 1px solid #e0e0e7;
      color: #555;
    }

    .criteria-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr) minmax(0, 0.8fr);
      gap: 0.5rem;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f0f0f5;
    }

    .criteria-grid.header {
      font-weight: 700;
      border-bottom: 2px solid #e0e0e7;
      margin-bottom: 0.25rem;
    }

    .criteria-name {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .criteria-desc {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.2rem;
    }

    .score-box {
      text-align: center;
      padding: 0.8rem;
      border-radius: 12px;
      background: #fdf2f7;
      border: 1px solid #f8c6dc;
    }

    .score-box h2 {
      margin: 0;
      font-size: 1.6rem;
    }

    .score-box p {
      margin: 0.2rem 0;
      font-size: 0.9rem;
    }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eee;
      margin-inline-start: 0.3rem;
    }

    .badge-good { background: #e0f7e9; color: #1b5e20; }
    .badge-mid { background: #fff8e1; color: #f57f17; }
    .badge-bad { background: #ffebee; color: #b71c1c; }

    .tips-list {
      list-style: none;
      padding: 0;
      margin: 0.4rem 0 0.7rem;
    }

    .tips-list li {
      margin-bottom: 0.4rem;
      padding-inline-start: 1rem;
      position: relative;
      font-size: 0.92rem;
    }

    .tips-list li::before {
      content: "•";
      position: absolute;
      right: 0;
      top: 0;
      color: #e91e63;
      font-size: 1.1rem;
      line-height: 1;
    }

    .student-scale {
      display: grid;
      grid-template-columns: 2.2fr 1.2fr;
      gap: 0.6rem;
      align-items: center;
      padding: 0.4rem 0;
      border-bottom: 1px solid #f0f0f5;
    }

    .student-scale:last-child {
      border-bottom: none;
    }

    input[type="range"] {
      width: 100%;
    }

    .range-value {
      font-size: 0.8rem;
      color: #666;
      text-align: left;
    }

    .section-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 0.3rem;
    }

    .muted {
      font-size: 0.85rem;
      color: #777;
      margin: 0.2rem 0 0.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.6rem;
      font-size: 0.9rem;
    }

    th, td {
      border: 1px solid #e0e0e7;
      padding: 0.4rem 0.5rem;
      text-align: right;
      white-space: nowrap;
      vertical-align: top;
    }

    th {
      background: #f5f5f9;
      font-weight: 600;
    }

    .small-input {
      max-width: 180px;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
      margin-top: 0.4rem;
    }

    @media (max-width: 720px) {
      .criteria-grid {
        grid-template-columns: 1fr;
        align-items: flex-start;
      }
      .criteria-grid.header {
        display: none;
      }
      .student-scale {
        grid-template-columns: 1fr;
      }
      th, td {
        white-space: normal;
      }
    }

    @media print {
      body {
        background: white;
      }
      header {
        box-shadow: none;
      }
      .role-toggle,
      button {
        display: none !important;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: 1px solid #ccc;
      }
      main {
        margin: 0;
        padding: 0.5rem;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>מחוון עבודות עם כלי בינה מלאכותית</h1>
    <p>בחירת תפקיד מורה או תלמיד, הערכה אוטומטית, ציון כולל וניהול רשימת תלמידים</p>
  </header>

  <main>
    <!-- בחירת תפקיד -->
    <section class="card">
      <div class="flex role-toggle">
        <button id="role-teacher" class="active" type="button">מורה</button>
        <button id="role-student" type="button">תלמיד</button>
      </div>
      <p class="muted">
        במצב מורה מוצג מחוון הציונים המלא וכלי לשמירת ציונים של תלמידים. במצב תלמיד מוצג כלי להערכה עצמית וטיפים לשימוש איכותי בכלי בינה מלאכותית.
      </p>
    </section>

    <!-- כרטיס למורה -->
    <section id="teacher-view" class="card">
      <div class="section-title">מחוון למורה - בחירת רמת ביצוע בכל קריטריון</div>
      <p class="muted">
        לכל קריטריון בחרי את רמת הביצוע המתאימה. המערכת מחשבת את הציון המספרי ואת רמת ההערכה הכללית.
      </p>

      <div class="criteria-grid header">
        <div>קריטריון</div>
        <div>רמת ביצוע</div>
        <div>נקודות</div>
      </div>

      <!-- הקריטריונים יווצרו דינמית ב-JS -->
      <div id="criteria-container"></div>

      <div class="flex space-between" style="margin-top:1rem; flex-wrap:wrap; gap:1rem;">
        <div class="score-box">
          <p>ציון כולל</p>
          <h2 id="total-score">0</h2>
          <p>
            רמת הערכה:
            <span id="overall-level">טרם הוזנו נתונים</span>
          </p>
          <p id="overall-comment" style="font-size:0.8rem; margin-top:0.3rem; color:#555;"></p>
          <button id="export-pdf-btn" type="button" style="margin-top:0.5rem;">ייצוא ל PDF (הדפסה)</button>
        </div>

        <div style="flex:1; min-width:220px;">
          <p style="font-weight:600; margin:0 0 0.4rem;">טבלת רמות הציון</p>
          <ul class="tips-list">
            <li><span class="badge badge-good">90-100</span> עבודה מעולה המשלבת חשיבה ביקורתית, שימוש מושכל בכלי בינה מלאכותית, עומק אקדמי ועמידה מלאה בהנחיות.</li>
            <li><span class="badge badge-good">80-89</span> עבודה טובה מאוד. יש חשיבה טובה ושימוש נבון בכלי בינה, אך יש מקום לשיפור באחד מהקריטריונים.</li>
            <li><span class="badge badge-mid">70-79</span> עבודה מספקת. נדרשים שיפור ודיוק במספר קריטריונים כדי להגיע לרמה גבוהה יותר.</li>
            <li><span class="badge badge-bad">פחות מ-70</span> עבודה שאינה מספקת. יש לחזור להנחיות, לחזק את החשיבה העצמאית ולשפר את האופן שבו נעשה שימוש בכלי בינה.</li>
          </ul>
        </div>
      </div>

      <!-- ניהול רשימת תלמידים -->
      <hr style="margin:1.3rem 0; border:none; border-top:1px solid #eee;">

      <div class="section-title">ניהול רשימת תלמידים וציונים</div>
      <p class="muted">
        לאחר חישוב הציון, ניתן לשמור את הנתונים של כל תלמיד בהרשימה. הרשימה נשמרת בדפדפן (localStorage) ותישאר גם בכניסה הבאה מהמחשב הזה.
      </p>

      <div class="controls-row">
        <div>
          <label for="student-name">שם תלמיד או תלמידה</label><br>
          <input id="student-name" type="text" class="small-input" placeholder="הקלידי שם">
        </div>
        <div>
          <label for="student-class">כיתה</label><br>
          <input id="student-class" type="text" class="small-input" placeholder="למשל יא 3">
        </div>
        <div>
          <label for="student-track">מגמה</label><br>
          <select id="student-track" class="small-input">
            <option value="">כללי</option>
            <option value="מדעי החברה">מדעי החברה</option>
            <option value="מדעים">מדעים</option>
            <option value="טכנולוגי">טכנולוגי</option>
            <option value="הומני">הומני</option>
            <option value="אחר">אחר</option>
          </select>
        </div>
        <div>
          <label for="student-role">תפקיד</label><br>
          <select id="student-role" class="small-input">
            <option value="עבודה אישית">עבודה אישית</option>
            <option value="עבודה קבוצתית">עבודה קבוצתית</option>
            <option value="פרזנטציה">פרזנטציה</option>
          </select>
        </div>
      </div>

      <div style="margin-top:0.8rem;">
        <label for="teacher-notes">הערות מורה</label><br>
        <textarea id="teacher-notes" placeholder="הקלידי כאן הערות כלליות על העבודה, נקודות לחיזוק, משוב אישי ועוד"></textarea>
      </div>

      <div class="controls-row" style="margin-top:0.8rem;">
        <button id="save-student-btn" type="button">שמור תלמיד</button>
        <button id="clear-students-btn" type="button" class="danger">מחיקת כל הרשימה</button>
        <button id="export-csv-btn" type="button" class="secondary">ייצוא רשימה ל CSV</button>
        <span id="save-message" class="muted"></span>
      </div>

      <table id="students-table">
        <thead>
          <tr>
            <th>שם</th>
            <th>כיתה</th>
            <th>מגמה</th>
            <th>תפקיד</th>
            <th>ציון</th>
            <th>רמה</th>
            <th>תאריך</th>
            <th>הערות מורה</th>
          </tr>
        </thead>
        <tbody id="students-tbody">
          <!-- רשומות תלמידים יווצרו כאן -->
        </tbody>
      </table>
    </section>

    <!-- כרטיס לתלמיד -->
    <section id="student-view" class="card" style="display:none;">
      <div class="section-title">כלי לתלמיד - הערכה עצמית וטיפים לשימוש איכותי</div>
      <p class="muted">
        השתמשי במחוון הזה כדי לבדוק את עצמך לפני ההגשה. דרגי כל קריטריון בין 1 ל-5, וקבלי חיווי מילולי מיידי.
      </p>

      <div id="student-scales"></div>

      <div class="score-box" style="margin-top:1rem;">
        <p>ממוצע הערכה עצמית</p>
        <h2 id="student-average">0.0</h2>
        <p>
          פרשנות:
          <span id="student-interpretation">טרם הוזנו נתונים</span>
        </p>
      </div>

      <hr style="margin:1.3rem 0; border:none; border-top:1px solid #eee;">

      <div class="section-title">טיפים חשובים לשימוש אפקטיבי בכלי בינה מלאכותית</div>
      <ul class="tips-list">
        <li><strong>חשיבה ביקורתית</strong> - אל תקבלי כל תשובה כמובן מאליו. בדקי מקורות, השווי למקורות נוספים ושאלי האם הטענה הגיונית.</li>
        <li><strong>שקיפות</strong> - כשאת משתמשת בכלי בינה, צייני זאת בעבודה בהתאם להנחיות המורה. צייני במה הכלי עזר ומה עשית בעצמך.</li>
        <li><strong>עריכה ושיפור</strong> - אל תגישי טקסט כמו שהוא. ערכי, שכתבתי, התאימי לשפה שלך והוסיפי דוגמאות אישיות.</li>
        <li><strong>תיעוד מקורות</strong> - רשמי מאיפה לקחת מידע, אילו אתרים קראת ואילו חלקים נכתבו בעזרת הכלי.</li>
        <li><strong>מניעת שימוש בעייתי</strong> - הימנעי מהעתקה מלאה בלי הבנה, מהצגת רעיונות של הכלי כאילו הם שלך בלבד, או משימוש במידע שאינו אמין.</li>
      </ul>
    </section>
  </main>

  <script>
    // נתוני המחוון
    const criteriaData = [
      {
        id: "crit1",
        name: "חשיבה ביקורתית והערכת מהימנות",
        max: 25,
        desc: "בדיקת מהימנות המידע, הצלבה בין מקורות ושילוב שיקול דעת עצמאי.",
        levels: [
          { label: "מעולה", points: 25, help: "בדיקה מעמיקה של מקורות, נימוקים חזקים ושילוב ביקורתיות." },
          { label: "טוב", points: 20, help: "בדיקה טובה של רוב המידע, יש מקום להעמקה נוספת." },
          { label: "מספק", points: 15, help: "בדיקה בסיסית בלבד, נדרשת הרחבה והצלבה עם מקורות נוספים." },
          { label: "לא מספק", points: 10, help: "הסתמכות כמעט מלאה על הכלי ללא בדיקה עצמאית." }
        ]
      },
      {
        id: "crit2",
        name: "איכות התוכן והעומק האקדמי",
        max: 20,
        desc: "עומק הדיון, דיוק מושגים ושילוב מקורות רלוונטיים.",
        levels: [
          { label: "מעולה", points: 20, help: "תוכן מעמיק, מאורגן היטב, מבוסס מקורות איכותיים." },
          { label: "טוב", points: 16, help: "תוכן טוב, חסרים מעט עומק או דוגמאות." },
          { label: "מספק", points: 10, help: "עומק חלקי, מספר שגיאות מושגיות." },
          { label: "לא מספק", points: 5, help: "תוכן שטחי מאוד או שגוי ברובו." }
        ]
      },
      {
        id: "crit3",
        name: "שקיפות בשימוש בכלי בינה מלאכותית",
        max: 10,
        desc: "מידת הדיווח על השימוש בכלי, תיעוד ושיתוף המורה.",
        levels: [
          { label: "מעולה", points: 10, help: "תיאור ברור של השימוש בכלי, מה תרם ומה נכתב עצמאית." },
          { label: "טוב", points: 8, help: "יש תיאור שימוש, אך אינו מפורט לגמרי." },
          { label: "מספק", points: 6, help: "רמז כללי בלבד לשימוש בכלי, ללא פירוט." },
          { label: "לא מספק", points: 3, help: "אין אזכור לשימוש בכלי או שהוא מוסתר." }
        ]
      },
      {
        id: "crit4",
        name: "עריכה ושיפור המוצר",
        max: 12,
        desc: "התאמת הטקסט לשפה אישית, שכתוב, תיקונים והרחבה.",
        levels: [
          { label: "מעולה", points: 12, help: "עריכה מקיפה, התאמת הסגנון האישי והוספת דוגמאות ותובנות." },
          { label: "טוב", points: 9, help: "בוצעו התאמות טובות, ניתן עדיין לדייק את הניסוח." },
          { label: "מספק", points: 6, help: "עריכה חלקית בלבד, חלקים נראים כמו יציאה ישירה מהכלי." },
          { label: "לא מספק", points: 3, help: "אין כמעט עריכה, הטקסט נראה כמו העתקה ישירה." }
        ]
      },
      {
        id: "crit5",
        name: "מבנה ועמידה בדרישות",
        max: 15,
        desc: "עמידה בהנחיות, סדר פנימי, חלוקה לפרקים ודרישות פורמליות.",
        levels: [
          { label: "מעולה", points: 15, help: "עמידה מלאה בכל ההנחיות ומבנה ברור ומסודר." },
          { label: "טוב", points: 11, help: "רוב ההנחיות מולאו, חסרים פרטים בודדים." },
          { label: "מספק", points: 8, help: "הנחיות מסוימות לא מולאו, המבנה חלקי." },
          { label: "לא מספק", points: 4, help: "חוסר סדר ואי עמידה משמעותית בדרישות." }
        ]
      },
      {
        id: "crit6",
        name: "פרזנטציה והצגה",
        max: 18,
        desc: "אופן ההצגה בעל פה או במצגת: עמידה מול קהל, עיצוב ושימוש במדיה.",
        levels: [
          { label: "מעולה", points: 18, help: "הצגה בטוחה וברורה, קשר עין טוב ושימוש מצוין במצגת או במדיה." },
          { label: "טוב", points: 14, help: "הצגה טובה, מעט היסוס או קריאה מהטקסט." },
          { label: "מספק", points: 10, help: "הצגה בסיסית, קריאה בעיקר מהמסך או הדף." },
          { label: "לא מספק", points: 6, help: "הצגה לא מובנית או לא ברורה, קושי משמעותי בתקשורת." }
        ]
      }
    ];

    let currentTotalScore = 0;
    let studentRecords = [];

    // בניית טבלת הקריטריונים למורה
    const criteriaContainer = document.getElementById("criteria-container");

    criteriaData.forEach(crit => {
      const row = document.createElement("div");
      row.className = "criteria-grid";
      row.dataset.critId = crit.id;

      const colName = document.createElement("div");
      colName.innerHTML = `
        <div class="criteria-name">${crit.name} <span style="font-size:0.8rem; color:#999;">(עד ${crit.max} נקודות)</span></div>
        <div class="criteria-desc">${crit.desc}</div>
      `;

      const colSelect = document.createElement("div");
      const select = document.createElement("select");
      select.dataset.critId = crit.id;
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "בחרי רמת ביצוע";
      select.appendChild(defaultOption);
      crit.levels.forEach((level, index) => {
        const opt = document.createElement("option");
        opt.value = index;
        opt.textContent = `${level.label} (${level.points} נקודות)`;
        select.appendChild(opt);
      });
      colSelect.appendChild(select);

      const colPoints = document.createElement("div");
      const pointsSpan = document.createElement("span");
      pointsSpan.id = `points-${crit.id}`;
      pointsSpan.textContent = "0";
      colPoints.appendChild(pointsSpan);

      row.appendChild(colName);
      row.appendChild(colSelect);
      row.appendChild(colPoints);

      criteriaContainer.appendChild(row);
    });

    function calculateTotal() {
      let sum = 0;
      let filled = 0;
      criteriaData.forEach(crit => {
        const select = document.querySelector(`select[data-crit-id="${crit.id}"]`);
        const pointsSpan = document.getElementById(`points-${crit.id}`);
        if (select && select.value !== "") {
          const level = crit.levels[Number(select.value)];
          pointsSpan.textContent = level.points;
          sum += level.points;
          filled++;
        } else {
          pointsSpan.textContent = "0";
        }
      });

      currentTotalScore = sum;

      const totalEl = document.getElementById("total-score");
      const levelEl = document.getElementById("overall-level");
      const commentEl = document.getElementById("overall-comment");

      totalEl.textContent = sum;

      if (filled === 0) {
        levelEl.textContent = "טרם הוזנו נתונים";
        commentEl.textContent = "";
        return;
      }

      let level;
      let comment;

      if (sum >= 90) {
        level = "מעולה";
        comment = "עבודה ברמה גבוהה מאוד. ניתן להשתמש בה כמודל לדוגמה ולהעמיק עוד יותר במקומות נקודתיים.";
      } else if (sum >= 80) {
        level = "טוב";
        comment = "עבודה טובה ומוקפדת. מומלץ לבחור קריטריון או שניים לשיפור נוסף כדי להגיע לרמה מעולה.";
      } else if (sum >= 70) {
        level = "מספק";
        comment = "עבודה שמראה מאמץ, אך נדרשים חיזוק והעמקה בכמה תחומים. כדאי לעבור על ההערות בכל קריטריון.";
      } else {
        level = "לא מספק";
        comment = "העבודה אינה עומדת בסטנדרט הרצוי. מומלץ לחזור להנחיות המחוון, לחזק את החשיבה העצמאית ולהשתמש בכלי הבינה בצורה מבוקרת יותר.";
      }

      levelEl.textContent = level;
      commentEl.textContent = comment;
    }

    // שינויי מורה
    criteriaContainer.addEventListener("change", function (event) {
      if (event.target.tagName === "SELECT") {
        calculateTotal();
      }
    });

    // מצב תלמיד - יצירת סרגלים
    const studentScalesContainer = document.getElementById("student-scales");
    const studentScaleTexts = [
      "אני בודק או בודקת את אמינות המידע ולא מסתפקת בתשובה הראשונה.",
      "אני משתמשת במקורות נוספים ולא רק בכלי הבינה.",
      "אני מציינת בעבודה מתי וכיצד השתמשתי בכלי.",
      "אני עורכת ומשפרת את הטקסט כך שיישמע כמו שפה שלי.",
      "אני מקפידה לעמוד בהנחיות המבנה והדרישות של המורה.",
      "אם יש פרזנטציה, אני מתכוננת אליה ולא קוראת מהמסך בלבד."
    ];

    criteriaData.forEach((crit, index) => {
      const row = document.createElement("div");
      row.className = "student-scale";

      const textCol = document.createElement("div");
      textCol.innerHTML = `
        <div class="criteria-name">${crit.name}</div>
        <div class="criteria-desc">${studentScaleTexts[index] || ""}</div>
      `;

      const controlCol = document.createElement("div");
      const range = document.createElement("input");
      range.type = "range";
      range.min = "1";
      range.max = "5";
      range.step = "1";
      range.value = "3";
      range.dataset.critId = crit.id;

      const valueLabel = document.createElement("div");
      valueLabel.className = "range-value";
      valueLabel.id = `student-val-${crit.id}`;
      valueLabel.textContent = "3 - בינוני";

      controlCol.appendChild(range);
      controlCol.appendChild(valueLabel);

      row.appendChild(textCol);
      row.appendChild(controlCol);

      studentScalesContainer.appendChild(row);
    });

    function interpretScaleValue(val) {
      val = Number(val);
      if (val === 5) return "5 - מצוין";
      if (val === 4) return "4 - טוב";
      if (val === 3) return "3 - בינוני";
      if (val === 2) return "2 - נמוך";
      return "1 - נמוך מאוד";
    }

    function updateStudentAverage() {
      const ranges = studentScalesContainer.querySelectorAll('input[type="range"]');
      let sum = 0;
      ranges.forEach(r => sum += Number(r.value));
      const avg = ranges.length ? (sum / ranges.length) : 0;
      document.getElementById("student-average").textContent = avg.toFixed(1);

      let interpretation;
      if (avg >= 4.5) {
        interpretation = "נראה שהעבודה מוכנה מאוד להגשה. כדאי לעבור רק על תיקונים קטנים.";
      } else if (avg >= 3.5) {
        interpretation = "הכיוון טוב, אך יש כמה נקודות שדורשות חיזוק ושיפור לפני ההגשה.";
      } else if (avg >= 2.5) {
        interpretation = "יש צורך בשיפור משמעותי בחלק מהקריטריונים. מומלץ לעבור שוב על הטיפים למעלה.";
      } else {
        interpretation = "נדרש שדרוג רציני של העבודה. חזרי להנחיות המחוון, בחרי קריטריון אחד להתחיל לשפר ואז המשיכי הלאה.";
      }

      document.getElementById("student-interpretation").textContent = interpretation;
    }

    studentScalesContainer.addEventListener("input", function (event) {
      if (event.target.type === "range") {
        const critId = event.target.dataset.critId;
        const label = document.getElementById(`student-val-${critId}`);
        label.textContent = interpretScaleValue(event.target.value);
        updateStudentAverage();
      }
    });

    // חישוב ראשוני לתלמיד
    updateStudentAverage();

    // מעבר בין מצבי מורה ותלמיד
    const teacherBtn = document.getElementById("role-teacher");
    const studentBtn = document.getElementById("role-student");
    const teacherView = document.getElementById("teacher-view");
    const studentView = document.getElementById("student-view");

    function setRole(role) {
      if (role === "teacher") {
        teacherBtn.classList.add("active");
        studentBtn.classList.remove("active");
        teacherView.style.display = "";
        studentView.style.display = "none";
      } else {
        studentBtn.classList.add("active");
        teacherBtn.classList.remove("active");
        studentView.style.display = "";
        teacherView.style.display = "none";
      }
    }

    teacherBtn.addEventListener("click", () => setRole("teacher"));
    studentBtn.addEventListener("click", () => setRole("student"));

    // ייצוא ל-PDF דרך הדפסה
    document.getElementById("export-pdf-btn").addEventListener("click", () => {
      window.print();
    });

    // ניהול רשימת תלמידים
    const STORAGE_KEY = "aiRubricStudents";
    const studentsTbody = document.getElementById("students-tbody");
    const saveMessage = document.getElementById("save-message");

    function loadRecordsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          studentRecords = [];
          return;
        }
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          studentRecords = parsed;
        } else {
          studentRecords = [];
        }
      } catch (e) {
        studentRecords = [];
      }
    }

    function saveRecordsToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(studentRecords));
    }

    function levelFromScore(score) {
      if (score >= 90) return "מעולה";
      if (score >= 80) return "טוב";
      if (score >= 70) return "מספק";
      return "לא מספק";
    }

    function renderRecordsTable() {
      studentsTbody.innerHTML = "";
      if (!studentRecords.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.textContent = "עדיין לא נשמרו תלמידים.";
        studentsTbody.appendChild(tr);
        tr.appendChild(td);
        return;
      }

      studentRecords.forEach(rec => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = rec.name || "";
        tr.appendChild(tdName);

        const tdClass = document.createElement("td");
        tdClass.textContent = rec.className || "";
        tr.appendChild(tdClass);

        const tdTrack = document.createElement("td");
        tdTrack.textContent = rec.track || "כללי";
        tr.appendChild(tdTrack);

        const tdRole = document.createElement("td");
        tdRole.textContent = rec.role || "";
        tr.appendChild(tdRole);

        const tdScore = document.createElement("td");
        tdScore.textContent = rec.score != null ? rec.score : "";
        tr.appendChild(tdScore);

        const tdLevel = document.createElement("td");
        tdLevel.textContent = levelFromScore(rec.score || 0);
        tr.appendChild(tdLevel);

        const tdDate = document.createElement("td");
        tdDate.textContent = rec.date || "";
        tr.appendChild(tdDate);

        const tdNotes = document.createElement("td");
        tdNotes.textContent = rec.notes || "";
        tr.appendChild(tdNotes);

        studentsTbody.appendChild(tr);
      });
    }

    loadRecordsFromStorage();
    renderRecordsTable();

    document.getElementById("save-student-btn").addEventListener("click", () => {
      const name = document.getElementById("student-name").value.trim();
      const className = document.getElementById("student-class").value.trim();
      const track = document.getElementById("student-track").value;
      const role = document.getElementById("student-role").value;
      const notes = document.getElementById("teacher-notes").value.trim();

      saveMessage.textContent = "";

      if (!name) {
        saveMessage.textContent = "יש להזין שם תלמיד או תלמידה לפני השמירה.";
        return;
      }

      // בדיקה שכל הקריטריונים סומנו
      let allSelected = true;
      criteriaData.forEach(crit => {
        const select = document.querySelector(`select[data-crit-id="${crit.id}"]`);
        if (!select || select.value === "") {
          allSelected = false;
        }
      });

      if (!allSelected) {
        saveMessage.textContent = "כדי לשמור תלמיד, יש לבחור רמת ביצוע בכל הקריטריונים.";
        return;
      }

      if (currentTotalScore === 0) {
        calculateTotal();
      }

      const now = new Date();
      const dateStr = now.toLocaleDateString("he-IL", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });

      const record = {
        id: Date.now(),
        name,
        className,
        track: track || "כללי",
        role,
        score: currentTotalScore,
        date: dateStr,
        notes
      };

      studentRecords.push(record);
      saveRecordsToStorage();
      renderRecordsTable();

      saveMessage.textContent = "התלמיד נשמר בהצלחה.";

      // ניקוי שדות מתאימים
      document.getElementById("student-name").value = "";
      document.getElementById("student-class").value = "";
      document.getElementById("teacher-notes").value = "";
    });

    document.getElementById("clear-students-btn").addEventListener("click", () => {
      if (!studentRecords.length) {
        saveMessage.textContent = "אין רשומה למחיקה.";
        return;
      }
      const confirmDelete = window.confirm("האם את בטוחה שברצונך למחוק את כל רשימת התלמידים?");
      if (!confirmDelete) return;

      studentRecords = [];
      saveRecordsToStorage();
      renderRecordsTable();
      saveMessage.textContent = "כל הרשימה נמחקה.";
    });

    // ייצוא ל CSV
    function escapeForCSV(value) {
      if (value == null) return "";
      const str = String(value).replace(/"/g, '""');
      return `"${str}"`;
    }

    document.getElementById("export-csv-btn").addEventListener("click", () => {
      if (!studentRecords.length) {
        saveMessage.textContent = "אין תלמידים לייצא.";
        return;
      }

      const headers = [
        "שם",
        "כיתה",
        "מגמה",
        "תפקיד",
        "ציון",
        "רמה",
        "תאריך",
        "הערות מורה"
      ];

      const rows = [];
      rows.push(headers.map(escapeForCSV).join(","));

      studentRecords.forEach(rec => {
        const row = [
          rec.name || "",
          rec.className || "",
          rec.track || "כללי",
          rec.role || "",
          rec.score != null ? rec.score : "",
          levelFromScore(rec.score || 0),
          rec.date || "",
          rec.notes || ""
        ];
        rows.push(row.map(escapeForCSV).join(","));
      });

      const csvContent = rows.join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "ai_rubric_students.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      saveMessage.textContent = "קובץ CSV נוצר ונשמר במחשב.";
    });
  </script>
</body>
</html>
